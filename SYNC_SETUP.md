# 多设备数据同步设置指南

## 1. 数据库设置

### 步骤 1: 在 Supabase Dashboard 中创建表

1. 打开 [Supabase Dashboard](https://app.supabase.com/)
2. 选择你的项目
3. 进入 **SQL Editor**
4. 复制 `supabase_setup.sql` 文件中的内容
5. 粘贴到 SQL Editor 中
6. 点击 **Run** 执行脚本

### 步骤 2: 启用 Realtime

1. 在 Supabase Dashboard 中，进入 **Database** → **Replication**
2. 找到 `clothes_items` 表，点击启用 Realtime
3. 找到 `daughter_clothes_items` 表，点击启用 Realtime

## 2. 功能说明

### 2.1 同步流程

#### 登录后：
1. 自动从云端下载数据
2. 与本地 localStorage 数据合并（处理冲突）
3. 上传本地未同步的数据
4. 订阅实时更新

#### 数据操作时：
- **添加**：立即保存到本地，异步上传到云端
- **修改**：立即保存到本地，异步上传到云端
- **删除**：立即从本地删除，异步从云端删除

#### 接收更新：
- 通过 Supabase Realtime 接收其他设备的更新
- 自动更新本地状态和 localStorage
- 处理冲突：保留最新的 `updated_at` 版本

### 2.2 冲突处理策略

**最后写入获胜 (Last Write Wins)**
- 使用 `updated_at` 时间戳比较
- 如果两个设备同时修改同一物品：
  - 比较 `updated_at` 时间戳
  - 保留最新的版本
  - 丢弃较旧的版本

### 2.3 数据合并逻辑

```javascript
// 合并流程：
1. 先添加所有远程数据
2. 遍历本地数据：
   - 如果本地数据在远程不存在 → 添加
   - 如果存在 → 比较 updated_at
     - 本地更新 → 保留本地版本
     - 远程更新 → 保留远程版本
```

## 3. 使用说明

### 3.1 首次使用

1. **登录账号**：使用邮箱密码登录
2. **等待同步**：登录后会自动同步数据（首次可能需要几秒）
3. **查看状态**：可以在浏览器控制台查看同步日志

### 3.2 多设备使用

1. **设备 A（PC）**：
   - 登录 → 数据自动同步
   - 添加/修改/删除物品 → 自动上传到云端

2. **设备 B（手机）**：
   - 登录 → 自动下载云端数据
   - 实时接收设备 A 的更新
   - 添加/修改/删除物品 → 自动上传到云端

3. **设备 A**：
   - 自动接收设备 B 的更新
   - 无需刷新页面

### 3.3 离线支持

- **离线时**：数据操作正常，保存在 localStorage
- **上线后**：自动同步到云端
- **注意**：离线时的操作会在上线后同步，但不会实时推送到其他设备

## 4. 故障排查

### 4.1 同步失败

**检查项**：
1. 确认已登录
2. 检查网络连接
3. 查看浏览器控制台错误信息
4. 确认 Supabase 表已创建
5. 确认 Realtime 已启用

### 4.2 数据不同步

**检查项**：
1. 确认两个设备使用同一账号登录
2. 检查 Realtime 订阅状态（控制台日志）
3. 手动刷新页面重新同步

### 4.3 数据冲突

**处理方式**：
- 系统自动处理：保留最新的 `updated_at` 版本
- 如果发现数据丢失，可以：
  1. 检查浏览器控制台日志
  2. 查看 Supabase Dashboard 中的数据
  3. 手动重新同步

## 5. 技术细节

### 5.1 数据格式转换

- **本地格式** → **数据库格式**：`localToDbItem()`
- **数据库格式** → **本地格式**：`dbToLocalItem()`

### 5.2 同步函数

- `initializeSync()` - 初始化同步
- `subscribeToRealtimeUpdates()` - 订阅实时更新
- `syncItemToCloud()` - 同步单个项目到云端
- `handleRealtimeUpdate()` - 处理实时更新

### 5.3 性能优化

- 批量上传/下载
- 异步操作，不阻塞 UI
- 本地缓存（localStorage）提供快速访问
- 增量更新（只同步变更）

## 6. 安全说明

- **Row Level Security (RLS)**：确保用户只能访问自己的数据
- **认证要求**：所有操作都需要登录
- **数据隔离**：每个用户的数据完全隔离

## 7. 后续优化建议

1. **离线队列**：队列离线操作，上线后批量同步
2. **冲突提示**：当检测到冲突时，提示用户选择
3. **同步状态显示**：在 UI 中显示同步状态
4. **数据版本控制**：使用版本号而非时间戳
5. **批量操作优化**：大量数据时分页加载
